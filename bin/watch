#!/usr/bin/env bash
#
#
#
FIRST_RUN="$FIRST_RUN"
set -u -e -o pipefail

if [[ -z "$IS_DEV" ]]
then
  echo "Not a dev machine." 1>&2
  exit 1
fi

start_server () {
  bin/start &
}

restart_server () {
  if [[ $FILE =~ ".rb" ]]
  then
    pkill -HUP  -f  "unicorn master" || echo "$? -- process"
  fi
}

if [[ -z "$FIRST_RUN" ]]
then
  if [[ $FILE =~ ".rb" ]]
  then

    if [[ "$FILE" =~ "Public/" && ! "$FILE" =~ "mustache." ]]
    then
      echo "Template: $FILE"
      bin/compile_html $FILE
    fi

    echo "Restarting the server..."
    restart_server
  fi
fi

cleanup () {
  echo "Quitting..."
  sleep 2 # Wait for unicorn to finish starting.
  pkill -QUIT -f "unicorn master"
  echo "Done"
}

# trap cleanup SIGINT SIGTERM EXIT

echo "=========================="
echo ""
