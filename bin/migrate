#!/usr/bin/env node


var db             = require('okdoki/lib/POSTGRESQL');
var show_databases = db.show_databases;
var _              = require('underscore');
var cmd            = (process.argv[2] || 'nothing');
var is_reset       = cmd === 'reset';
var is_up          = is_reset || cmd === 'up';
var is_down        = is_reset || cmd === 'down';
var is_list        = cmd === 'list';

if (!is_up && !is_down && !is_list) {
  console.log('Unknown cmd: ' + process.argv[2]);
  process.exit(1);
}

show_databases(function (names) {

  if (cmd === 'list') {
    console.log('DBs: ' + names.join(', '));
    return true;
  }

  var query = new db.query();

  _.each(names, function (n, i) {
    if (n.indexOf('customer-') === 0 || n.indexOf('customer_') === 0) {
      query.q('DROP DATABASE "' + n + '"' );
    };
  });

  if (is_down) {
    query.q('DROP EXTENSION IF EXISTS hstore');
    query.q('DROP TABLE IF EXISTS bot_chat');
    query.q('DROP TABLE IF EXISTS customers');
    query.q('DROP TABLE IF EXISTS screen_names');
    query.q('DROP TABLE IF EXISTS consumers');
    query.q('DROP TABLE IF EXISTS masks');
  }


  if (is_up) {
    query.q("CREATE EXTENSION hstore");

    query.q(" \
     CREATE TABLE IF NOT EXISTS customers ( \
       id varchar(15) PRIMARY KEY NOT NULL UNIQUE, \
       created_at timestamp default (now() AT TIME ZONE 'UTC'),  \
       trashed_at timestamp default null,   \
       email text,                 \
       passphrase_hash varchar(100) NOT NULL \
    )");

    query.q( " \
     CREATE TABLE IF NOT EXISTS screen_names ( \
       id varchar(15) PRIMARY KEY NOT NULL UNIQUE,   \
       customer_id varchar(15) NOT NULL, \
       created_at timestamp default (now() AT TIME ZONE 'UTC'),  \
       trashed_at timestamp default null,   \
       screen_name varchar(15) NOT NULL UNIQUE \
    )");
  }

  query.run_and_then(function (meta) {
    console.log('Finished migrating the db.');
  });

}); // === show_databases



// ==========================================================================================


console.log('Process id: ' + process.pid);




