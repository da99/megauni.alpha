#!/usr/bin/env bash
#
#
#

FIRST_RUN="$FIRST_RUN"
CMD="$CMD"
set -u -e -o pipefail

if [[ -z "$IS_DEV" ]]
then
  echo "Not a dev machine." 1>&2
  exit 1000
fi

unicorn_pid () {
 pgrep -f "unicorn master" || echo ""
}


restart_server () {

  unicorn=/tmp/unicorn.dev.restart
  since=0

  if [[ -f $unicorn ]]
  then
    since="$(expr "$(date +%s)" - "$(stat $unicorn -c %Y)" )"
  fi

  touch $unicorn

  if [[ "$since" -gt "3" ]]
  then
    echo "=== $since seconds: Restarting the server..."
    pkill -f "unicorn master" || true
    bin/start &
    echo "Done"
  else
    echo "=== No restart: $since secs"
  fi

}

if [[ -z "$FIRST_RUN" ]]
then

  if [[ $FILE =~ ".rb" && ! "$FILE" =~ "layout.rb"  ]]
  then

    if [[ "$FILE" =~ "Public/" && ! "$FILE" =~ "mustache." ]]
    then
      $yellow "=== Please wait... compiling..."
      if [[ "$FILE" =~ "applets" ]]
      then
        bin/compile_html all
      else
        bin/compile_html $FILE
      fi
      $green $(restart_server)
    else
      if [[ ! -z "$@" ]]
      then
        bin/test "$@"
      else
        if [[ "$FILE" =~ "Server/" ]]
        then
          $green $(restart_server)
        else
          if [[ ! "$FILE" =~ "markup.mustache.rb" ]]
          then
            echo "Unknown file: $FILE"
          fi
        fi # --- restart server if Server/
      fi
    fi

  else
    echo "=== ignoring: $FILE"
  fi

else
  restart_server
  if [[ ! -z "$@" ]]
  then
    bin/test "$@"
  fi
fi


# trap cleanup SIGINT SIGTERM EXIT
