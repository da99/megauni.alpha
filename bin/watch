#!/usr/bin/env node

var watch = require('ok_dev_watch');
var exec  = require("child_process").exec;
var spawn = require("child_process").spawn;

var shell = watch.shell;

// ****************************************************************
// ****************** Start watching... ***************************
// ****************************************************************


watch.dir( ["lib", "views"], function (filename, river) {
  console.log("changed: " + filename);
  shutdown_server(function () {
    console.log("\nRe-starting server...");
    restart_server(river.fin);
  });
});

watch.dir("test", function (filename) {
  console.log("test: " + filename);
  river.fin();
});

watch.dir("bin/watch", function (file_name) {
  console.log("\nFile bin/watch has changed. Exiting.");
  shutdown();
});

var public = "public/assets/css";

watch.dir("stylus_css", function (file_name, river) {
  watch.shell("stylus " + file_name + " -o " + public, river.fin);
});

watch.dir(public, function (style, river) {
  var css    = style.replace(".stylus.css", ".css").replace(".styl", ".css");
  if (style !== css) {
    shell("mv " + style + " " + css, function () {
      console.log("  moved to:" + css, "\n");
      river.fin();
    });
  } else
    river.fin();
});

console.log("Watching: ", watch.dirs.join(', '), "\n");

function shutdown_server(func) {
  exec('bin/stop', function (err, so, se) {
    watch.print_stdio(so, se);
    if (err && !err.message.indexOf("no process found")) {
      console.log("Exiting because: " + err);
      process.exit(1);
    }
    func();
  });
}

function restart_server(func) {

  var server = spawn("bin/restart");
  server.stdout.on('data', function (data) {
    process.stdout.write("" + data);
  });

  server.stderr.on('data', function (data) {
    process.stdout.write("" + data);
  });

  server.on('close', function (code) {
    console.log('server closed: ' + code);
  });

  if (func)
    func();
}

restart_server();

function shutdown() {
  shutdown_server(function () {
    process.exit(0);
  });
}

process.on('SIGINT',  shutdown);
process.on('SIGTERM', shutdown);







