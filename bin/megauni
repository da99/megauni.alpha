#!/usr/bin/env bash
# -*- bash -*-
#
#
dev="$IS_DEV"
IS_DEV="$IS_DEV"
action="$1"
shift

if [[ -z "$PORT" ]]; then
  export PORT=4567
fi

if [[ -n "$IS_DEV" ]]; then
  dir="$(pwd)"
  export JAR="$dir/tmp/cookies.txt"
  export PID="$dir/tmp/{$PORT}.pid"
  export LOG="$dir/tmp/log.txt"
fi

export MODEL="$MODEL"
export USE_SERVER="$USE_SERVER"
export MOCHA="${MOCHA}"
export SPECS="$SPECS"
export RUN_FAST="${RUN_FAST}"

set -u -e -o pipefail


# ==============================================================
GREEN=$(tput setaf 2)
RED='\e[0;31m'
RESET_COLOR=$(tput sgr0)
GREEN_BG=$(tput setab 2)
echo "==="
WHITE=$(tput setaf 7)
BOLD_WHITE_ON_GREEN=$(tput bold)${WHITE}${GREEN_BG}
BOLD_WHITE=$(tput bold)${WHITE}
ORANGE='\e[0;33m'
BG_RED='\e[1;31m'
# ===============================================

mods=(
  Megauni
  Screen_Name
  User
  Log_In
  Card
  Link
)

# === Create a reverse of the list.
rev_mods=()
for (( idx=${#mods[@]}-1 ; idx >= 0 ; idx-- ))
do
  rev_mods+=( "${mods[idx]}" )
done
# ===============================================

case "$action" in

  help|--help)
    echo ""
    echo "  $  stop"
    echo "  $  restart"
    echo "  $  watch"
    echo ""
    echo "  $  migrate"
    echo "  $  migrate   up"
    echo "  $  migrate   down"
    echo "  $  migrate   reset"
    echo "  $  migrate   reset   MODEL"
    echo "  $  migrate   default_data"
    echo "  $  migrate   create  MODEL name"
    echo "  $  migrate   status"
    echo ""
    echo "  $  test"
    echo "  $  test reset"
    echo "  $  test Model spec"
    echo ""
    echo "  $  npm  ...."
    echo "  $  npm  --save ...."
    echo ""
    echo "  $  render name"
    echo "  $  render file_name"
    echo ""
    echo "  $  POST  \"{.. JSON .. }\"  /path"
    echo ""
    bash_setup print_help $0
    exit 0
    ;;

  "type_names")
    # === bash> type_names
    # ===    ME_ONLY
    # ===    ...
    IFS=$'\n'
    for line in $(cat lib/Link/migrates/__-link_type_id.sql)
    do
      if [[ $line =~ ^[[:space:]]+WHEN[[:space:]]+.+THEN ]]; then
        IFS="'" read -ra WORDS <<< "$line"
        code="$(bash_setup string_to_num "${WORDS[1]}")"

        start_keeping=""
        comment=""
        while read -n1 comm_char; do
          if [[ -n "$start_keeping" ]] ; then
            comment="${comment}${comm_char}"
          else
            if [[ "$comm_char" == "-"  ]]; then
              comment="-"
              start_keeping="yes"
            fi;
          fi;
        done < <(echo -n "$line")

        IFS=' -- ' read -ra COMMENTS <<< "$line"
        # echo "${WORDS[1]} $code ${comment}"
        echo "WHEN '${WORDS[1]}'    THEN RETURN $code; $comment"
      fi

    done
    ;;

  "model_list")
    # === bash> model_list
    # ===    User
    # ===    Screen_Name
    # === bash> model_list rsort
    # ===    Screen_Name
    # ===    User

    if [[ "$@" == "rsort" ]]; then
      for (( idx=${#mods[@]}-1 ; idx >= 0 ; idx-- ))
      do
        echo "${mods[idx]}"
      done
    else
      for i in ${mods[@]}
      do
        echo "$i"
      done
    fi
    ;;

  "start")
    # === bin/megauni start  # To be used on dev machines only.
    # === bin/megauni start daemon

    if [[ "$@" == *watch* ]]; then
      while read -r CHANGE
      do
        dir=$(echo "$CHANGE" | cut -d' ' -f 1)
        op=$(echo "$CHANGE" | cut -d' ' -f 2)
        file=$(echo "$CHANGE" | cut -d' ' -f 3)
        path="${dir}$file"
        file=$(basename $path)
        echo -e "=== $CHANGE ($path)"
        if [[ ! -f /tmp/compile.megauni ]]; then
          bin/megauni stop || :
        fi
      done < <(inotifywait --quiet --monitor --event close_write -r lib/ ./*.ex* )
      exit 0
    fi


    export IS_RUNNING_WWW_SERVER="true"
    export MIX_ENV="prod"

    elixir="elixir --no-halt"
    cmd="-S mix do compile, megauni.server"

    # === if on a non-DEV machine:
    if ! bash_setup dev!; then
      $elixir --detached $cmd
      exit 0
    fi

    # === DEV machine:
    touch /tmp/erl_crash.dump
    rm -f erl_crash.dump
    ln -s /tmp/erl_crash.dump erl_crash.dump

    ( bin/megauni start watch ) &
    exit_code="-1"
    while [[ "$exit_code" != "0" ]]
    do
      echo ""
      echo "=== Starting server..." 1>&2
      $elixir $cmd && exit_code="0" || exit_code=$?
      if [[ "$exit_code" == "1" ]]; then
        echo -n "=== Exited: $exit_code Waiting "
        sleep 1 && echo -n "." && sleep 1 && echo -n "." && sleep 1 && echo -n "."
        sleep 1 && echo -n "." && sleep 1 && echo -n "."
      else
        sleep 0
      fi
    done
    exit 0

    ;;

  "stop")
    pids="$(bin/megauni status)"
    if [[ -z "$pids" ]]; then
      echo "=== No server procs found." 1>&2
    fi

    while read -r num; do
      if [[ -n "$num" ]]; then
        echo "=== KILL-ing: $num"
        kill $num || echo "=== kill error"
      fi
    done < <(bin/megauni status)
    ;;

  "restart")
    bin/megauni stop
    bin/megauni start
    ;;

  "status")
    # === bin/megauni status
    # === Prints a list of server OS process.
    # === Prints to STDERR if no proces found.
    # === Always exits w/ 0
    pgrep -f "elixir.+megauni\.server(\s|$|,)" || (echo "=== No process found" 1>&2)
    ;;


  "iojs")
    # === $ bin/megauni iojs
    # === $ bin/megauni iojs  ....

    node --es_staging "$@"
    ;;

  "js_applet")
    app_dir="Public/applets"
    mkdir -p $app_dir/$1
    file="$app_dir/$1/script.js"
    if [[ -f $file ]]
    then
      echo "=== Already exists: $file"
      exit 0
    fi
      echo -e "\"use strict\";\n" >> $file

    echo "Created: $file"
    ;;


  "start as node app")
    if [[ -n "$dev" && -z "$USE_SERVER" ]]; then
      echo "=== Not starting server."
      exit 0
    fi
    PORT=$PORT $0 pm2 startOrGracefulReload megauni.pm2.json5 "$@"
    exit 0

    dir="$(pwd)/tmp"
    args=""
    if [[ ! -z "$dev" ]]; then
      args=" \
      --ssl --ssl-certificate $dir/ssl/server.crt \
      --ssl-certificate-key   $dir/ssl/server.key \
      --ssl-port 4568"
    fi

    if [[ ! -z "$dev" && ! -d tmp/ssl ]]; then
      folder="tmp/ssl"
      mkdir -p "$folder"
      cd $folder

      openssl genrsa -des3 -out server.key 1024

      # === For now, leave the challenge password and
      # company name blank.
      openssl req     -new -key server.key -out server.csr

      # === Remove password
      cp server.key server.key.org
      openssl rsa -in server.key.org -out server.key

      # === Generate a Self-Signed Certificate
      openssl x509 -req -days 30 -in server.csr -signkey server.key -out server.crt

      # sudo chown root:root server.*

      chmod 400 server.*
    fi

    # puma --config configs/puma.rb configs/config.ru


    # More options at:
    # https://github.com/phusion/passenger/blob/master/lib/phusion_passenger/standalone/start_command.rb
    RACK_ENV=production bundle exec passenger start   \
      $args                                           \
      --pid-file=$dir/4567.pid                        \
      --log-file=$dir/4567.log                        \
      --port 4567                                     \
      --rackup configs/config.ru                      \
      --static-files-dir      $dir/../Public
    ;;

  "migrate")
    if [[ -z "$@" ]]; then
      sub_action="up"
    else
      sub_action="$1"
      shift
    fi

    case "$sub_action" in
      "create")
        model="$1"
        name="$2"
        shift
        shift
        cd lib
        duck_duck_duck create $model $name
        ;;

      "reset")
        model="$@"

        bin/megauni migrate down "$model"
        bin/megauni migrate up   "$model"
        echo ""
        # if [[ -z "$model" ]]; then
          # ALLOW_BANNED_SCREEN_NAME=true bin/megauni migrate default_data
        # fi
        # echo -e "\n===== DONE =====\n"
        ;;

      "default_data")
        bin/migrate_default_data
        ;;

      "status")
        script="
          require 'sequel'
          DB = Sequel.connect('$DATABASE_URL')
          if DB.table_exists?(:_schema)
            rows = []
            DB.from(:_schema).each { |r|
              rows << r
              puts r.inspect
            }
            puts '== No records found.' if rows.empty?
          else
            puts '== Table not found.'
          end
        "
        ruby -e "$script"
        ;;

      "up")
        model="$@"

        if [[ -z "$model" ]]
        then
          for m in ${mods[@]}
          do
            bin/megauni migrate up $m
          done
          echo -e "\n=== Done.\n"
        else
          cd lib
          echo ""
          duck_duck_duck up $model
        fi
        ;;

      "down")
        model="$@"

        if [[ -z "$model" ]]
        then

          # === Ensure dev machine.
          if [ ! -n "${IS_DEV+x}" ]
          then
            echo "This is not a dev machine."
            exit 1
          fi

          # === Reverse list
          for m in ${rev_mods[@]}
          do
            bin/megauni migrate down $m
          done

        else
          cd lib
          echo ""
          duck_duck_duck down $model
        fi
        ;;

      *)
        echo "Unknown command for migrate: $sub_action"
        exit 1
        ;;
    esac # === sub_action
    ;;

  "highlight_ruby")
    while read i
    do
      code="$(echo "$i" | cut -d' ' -f9 || echo '')"
      path="$(echo "$i" | cut -d' ' -f7 || echo '')"
      if [[ ! -z "$code" && "$code" =~ $re ]]; then
        if [[ "$code" -gt 199 && "$code" -lt 300 ]]; then
          color="$GREEN"
        fi
        if [[ "$code" -gt 299 && "$code" -lt 400 ]]; then
          color="$ORANGE"
        fi
        if [[ "$code" -gt 399 && "$code" -lt 500 ]]; then
          color="$RED"
        fi
        if [[ "$code" -gt 499 ]]; then
          color="$BRED"
        fi
        color_code="${i/" $code "/"${color} ${code} ${RESET_COLOR}"}"
        echo -e "${color_code/"$path "/"${color}$path ${RESET_COLOR}"}"
      else
        if [[ ! ( "$i" == *ruby* ) ]]; then
          if [[ "$i" =~ ':in ' ]]; then
            echo -e "${RED}$i${RESET_COLOR}"
          else
            echo -e "$i"
          fi
        fi
      fi
    done # === while read output
    ;;


  "test")
    file="/tmp/specs.are.running"
    # === Run all the specs of the projects.
    touch $file
    PORT=4001 mix run spec/Spec.ex $@
    rm "$file" || :
    ;;

  "json")
    node_modules/json/lib/json.js "$@"
    ;;

  "running?")
    stat="$(bin/megauni pm2 jlist | bin/megauni json '[0].pm2_env.status')"
    if [[ "$stat" == 'online' ]]; then
      exit 0
    else
      exit 1
    fi
    ;;

  jshint)
    if [[ -n "$@" ]]; then
      js_setup jshint! $@
      exit 0
    fi

    js_files="$(echo -e lib/*/specs/*.json)"
    IFS=$' '
    for file in $js_files
    do
      if [[ -f $file ]]; then
        js_setup jshint $file
      fi
    done
    ;;

  "run_specs")
    if [[ -z "$dev" ]]; then
      exit 0
    fi

    if [[ -z "$@" ]]; then
      args="$SPECS"
    else
      args="$@"
    fi

    if [[ -n "$args" ]]; then
      eval $0 mocha "$MOCHA" "$args" || echo -e "=== ${RED}FAIL${RESET_COLOR} ==="
    fi
    ;;

  "__watch")
    $0 test $@ || :

    eval "$(bash_setup setup_traps)"
    setup_traps

    echo -e "=== Watching ${BOLD_WHITE}$(basename $0)${RESET_COLOR}    (proc $$)..."
    while read -r CHANGE
    do
      dir=$(echo "$CHANGE" | cut -d' ' -f 1)
      op=$(echo "$CHANGE" | cut -d' ' -f 2)
      file=$(echo "$CHANGE" | cut -d' ' -f 3)
      path="${dir}$file"
      file=$(basename $path)

      echo -e "=== $CHANGE ($path)"

      if [[ ! -z "$file" ]]; then

        if [[ "$path" == *bin/megauni* ]]; then
          break
        fi

        if [[ "$file" == *.sql ]]; then
          ( bin/megauni migrate up "$(basename $(dirname $(dirname "$path")))" && $0 test $@ ) || :
        else
          if [[ "$file" == *.js ]]; then
            js_pass="true"
            js_setup jshint! $path || js_pass=""

            if [[ -n "$js_pass" ]]; then
              $0 run_specs $@ || :
              bin/megauni restart
            fi # === if $js_pass
          else
            if [[ "$path" == *.json ]]; then
              (js_setup jshint! $path && $0 test $@)  || :
            else
              $0 test $@ || :
            fi
          fi # === if $file == *.js
        fi


      fi # === if $file

      echo ""
    done < <(inotifywait --quiet --monitor --event close_write -r lib/ -r spec/ $(git ls-files | grep -E "\.js$|bin\/megauni" | tr '\n' ' '))

    echo ""
    echo "=== ${GREEN}Reloading${RESET_COLOR} this script: $0 $action"
    exec $0 $action $@
    ;;

  "watch")
    # === watch

    # === temporary convenience
    export RUN_FAST="yes"

    eval "$(bash_setup setup_traps)"
    setup_traps

    # === Regular expression:
    IFS=$'\n'
    re='^[0-9]+$'
    # === Start server:

    echo -e "=== $(basename $0): Proc: $$ Proc Group: $(bash_setup proc_group $$)"

    if [[ -z "$RUN_FAST" ]] ; then
      $0 jshint
    fi

    if [[ -z "$USE_SERVER" ]]; then
      echo "=== Skipping server."
      bin/megauni __watch "$@"

    else
      ( bin/megauni __watch ) &
      sleep 1
      exit_code=-1
      while [[ "$exit_code" != "0" ]]
      do
        if [[ -f "/tmp/specs.are.running" ]]; then
          sleep 0.5
        else
          bin/megauni start || exit_code=$?
        fi
      done
      echo "=== Done looping server."
    fi # === if -z $USE_SERVER

    ;;

  "POST")
    curl -k -X POST --header "Content-Type:application/json" -d "$1" http://localhost:4567$2
    echo ""
    ;;

  "deploy")
    sudo apt-get install erlang-dev
    apt-cache show libpg-dev 1>/dev/null || (
      echo "=== Installing libpg-dev..."
      sudo apt-get install libpq-dev
    )
    npm install
    ;;

  "mocha")
    js_setup mocha --require co-mocha "$@"
    ;;

  *)

    file="$( echo node_modules/*/bin/$action )"
    args="$@"

    if [[ -f "$file"  ]]; then
      $0 iojs $file "$@"
      exit 0
    fi

    echo "Unknown action: $action" 1>&2
    exit 1
    ;;

esac # === case $action



