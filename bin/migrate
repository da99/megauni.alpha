#!/usr/bin/env bash
# -*- bash -*-
#
action="$1"
shift

model="$1"
shift

other="$@"

set -u -e -o pipefail

mods=( Customer Screen_Name );

if [[ -z "$action" ]]
then
  action="up"
fi


function run_up {

  for m in ${mods[@]}
  do
    echo "=== Migrating: up $m"
    bin/migrate_up $m
    echo ""
  done

}

function run_down {

  # === Ensure dev machine.
  if [ ! -n "${IS_DEV+x}" ]
  then
    echo "This is not a dev machine."
    exit 1
  fi

  # === Reverse list
  new_mods=()
  for (( idx=${#mods[@]}-1 ; idx >= 0 ; idx-- ))
  do
    new_mods+=( "${mods[idx]}" )
  done

  for m in ${new_mods[@]}
  do
    echo "=== Migrating: down $m"
    bin/migrate_down $m
    echo ""
  done

}

case "$action" in
  create)
    if [[ ! "${mods[@]}" == *"$2"* ]]
    then
      echo "$2 not in list."
      exit 1
    fi

    bin/migrate_create "$@"
    ;;

  list)
    echo "not ready"
    echo 1
    ;;

  reset)
    bin/migrate down "$model"
    bin/migrate up   "$model"
    ;;

  *)
    if [[ "$action" != "up" &&  "$action" != "down" ]]
    then
      echo "Unknown command: $action"
      exit 1
    fi

    if [[ -z "$model" ]]
    then
      run_$action
    else
      bin/migrate_$action $model
    fi

    ;;

esac

