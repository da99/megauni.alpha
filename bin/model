#!/usr/bin/env bash
# -*- bash -*-
#
# Examples:
#    bin/model create Chat
#    bin/model file   Chat Chat_Room_Fav
#

cmd="$1"
class="$2"
instance="$(echo $class | tr '[A-Z]' '[a-z]')"

set -u -e -o pipefail

compile_all () {
  mkdir -p Server/$class/model


  tmpl="Server/Ok/templates/model.rb"
  template model "model.rb"

  tmpl="Server/Ok/templates/model.action.rb"
  template create "model/create.rb"
  template read   "model/read.rb"
  template update "model/update.rb"
  template trash  "model/trash.rb"
  template delete "model/delete.rb"

  tmpl="Server/Ok/templates/routes.rb"
  template route "routes.rb"

}

template () {
  action="$1"
  new_file="Server/$class/$2"

  if [[ -f "$new_file" ]]
  then
    $yellow "=== already exists: $new_file"
  else
    sed "s/MODEL/$class/g"  "$tmpl" >> "$new_file"
    sed "s/!model/$instance/g"   -i "$new_file"
    sed "s/!action/$action/g"    -i "$new_file"
    echo "=== created: $new_file"
  fi

}


case "$cmd" in
  create)
    compile_all
    ;;

  *)
    echo "Unknown command: $@"
    exit 1
    ;;

esac


