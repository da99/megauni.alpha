<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
  <title>eval_this (BusyFixture)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre><span class="ruby-comment cmt"># File scraps/busy_fixture.rb, line 20</span>
  <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">eval_this</span>( <span class="ruby-identifier">data</span>, <span class="ruby-identifier">target_binding</span> )

    <span class="ruby-identifier">previous_keys</span> = []

    <span class="ruby-comment cmt"># ==== Get data, turn it from YAML to Ruby</span>
    <span class="ruby-identifier">data</span> = <span class="ruby-identifier">data</span>
    <span class="ruby-comment cmt"># ======================================</span>
    
    <span class="ruby-identifier">this_self</span> = <span class="ruby-keyword kw">self</span>
    <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">raw_key</span>, <span class="ruby-identifier">vals</span><span class="ruby-operator">|</span>
    
      <span class="ruby-identifier">key</span> = <span class="ruby-identifier">raw_key</span>.<span class="ruby-identifier">strip</span>
      <span class="ruby-identifier">current_key_val</span> = <span class="ruby-identifier">eval</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">target_binding</span>)

      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">previous_keys</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">key</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">InstanceVariableNameAlreadyUsed</span>, <span class="ruby-node">&quot;Key already used once: #{key}&quot;</span>
      <span class="ruby-keyword kw">end</span>
      
      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_key_val</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_key_val</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>][<span class="ruby-identifier">:class</span>]
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">InstanceVariableNameInUse</span>, <span class="ruby-node">&quot;Instance variable name is already in use: #{key} ==&gt; #{current_key_val.inspect}&quot;</span>
      <span class="ruby-keyword kw">end</span>

      <span class="ruby-identifier">previous_keys</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">key</span>
      
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">MissingMetaData</span>, <span class="ruby-node">&quot;:meta key missing for #{key}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">vals</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">:meta</span>)      
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">MissingMetaData</span>, <span class="ruby-node">&quot;:meta[:class] missing for #{key}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>].<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">:class</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">MissingMetaData</span>, <span class="ruby-node">&quot;:meta[:search_by] and :meta[:create_if] are missing for #{key}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>].<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">:search_by</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>].<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">:create_if</span>)

      <span class="ruby-comment cmt"># Make sure we have the right keys.</span>
      <span class="ruby-identifier">unknown_meta</span> = (<span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>].<span class="ruby-identifier">keys</span> <span class="ruby-operator">-</span> <span class="ruby-constant">VALID_META_KEYS</span> ).<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">inspect</span> }
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownMetaData</span>, <span class="ruby-node">&quot;Unknown keys in meta data: #{unknown_meta.join(',')}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">unknown_meta</span>.<span class="ruby-identifier">empty?</span>

      <span class="ruby-identifier">class_name</span>  = <span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>][<span class="ruby-identifier">:class</span>].<span class="ruby-identifier">strip</span>
      <span class="ruby-identifier">model_class</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>( <span class="ruby-identifier">class_name</span> )
      
      <span class="ruby-identifier">record</span> = <span class="ruby-keyword kw">nil</span>
      
      <span class="ruby-comment cmt"># Search for object.</span>
      <span class="ruby-comment cmt"># Save it to a local variable in this binding and</span>
      <span class="ruby-comment cmt"># to an instance variable in the original binding.</span>
      <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>][<span class="ruby-identifier">:search_by</span>]
      
        <span class="ruby-keyword kw">when</span> <span class="ruby-constant">String</span>
          <span class="ruby-identifier">code_search_for_record</span> = <span class="ruby-node">&quot; #{key} = #{vals[:meta][:search_by]} &quot;</span>
          <span class="ruby-keyword kw">begin</span>
            <span class="ruby-identifier">record</span> = <span class="ruby-identifier">eval</span>(  <span class="ruby-identifier">code_search_for_record</span>, <span class="ruby-identifier">target_binding</span>, <span class="ruby-keyword kw">__FILE__</span>, <span class="ruby-keyword kw">__LINE__</span> )
          <span class="ruby-keyword kw">rescue</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">RuntimeError</span>, <span class="ruby-node">&quot;Could not evaluate: #{code_search_for_record}\n #{$!.class} ===&gt; #{$!.message}&quot;</span>
          <span class="ruby-keyword kw">end</span>
        <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Symbol</span>
          <span class="ruby-identifier">field_search</span> = <span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>][<span class="ruby-identifier">:search_by</span>]
          <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Value for #{key}\##{field_search.inspect} is missing.&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">vals</span>[<span class="ruby-identifier">field_search</span>]
          <span class="ruby-identifier">record</span> = <span class="ruby-identifier">model_class</span>[ <span class="ruby-identifier">field_search</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">vals</span>[<span class="ruby-identifier">field_search</span>] ]
          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">record</span> <span class="ruby-comment cmt"># save it to original binding as an instance variable.</span>
            <span class="ruby-identifier">code_save_to_instance_var</span> = <span class="ruby-node">&quot; #{key} = #{model_class}[ #{field_search.inspect} =&gt; '#{vals[field_search]}' ] &quot;</span>
            <span class="ruby-keyword kw">begin</span>
              <span class="ruby-identifier">record</span> = <span class="ruby-identifier">eval</span>( <span class="ruby-identifier">code_save_to_instance_var</span> , <span class="ruby-identifier">target_binding</span>, <span class="ruby-keyword kw">__FILE__</span>, <span class="ruby-keyword kw">__LINE__</span> )
            <span class="ruby-keyword kw">rescue</span>
              <span class="ruby-identifier">raise</span> <span class="ruby-constant">RuntimeError</span>, <span class="ruby-node">&quot;Could not evaluate: #{code_save_to_instance_var}\n #{$!.class} ===&gt; #{$!.message}&quot;</span>
            <span class="ruby-keyword kw">end</span>
          <span class="ruby-keyword kw">end</span>
          
      <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># === case</span>

      
      <span class="ruby-comment cmt"># Determine if object needs to be created.</span>
      <span class="ruby-identifier">create_record</span> = <span class="ruby-keyword kw">true</span>
      <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">record</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>][<span class="ruby-identifier">:create_if</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">empty?</span>
        <span class="ruby-identifier">create_record</span> = <span class="ruby-identifier">eval</span>( <span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>][<span class="ruby-identifier">:create_if</span>] , <span class="ruby-identifier">target_binding</span>, <span class="ruby-keyword kw">__FILE__</span>, <span class="ruby-keyword kw">__LINE__</span>  )
      <span class="ruby-keyword kw">end</span>
      
      <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">record</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">create_record</span>
          
          <span class="ruby-identifier">arr_code</span> = []
          <span class="ruby-identifier">arr_code</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{key} = #{class_name}.new &quot;</span>
          ( <span class="ruby-identifier">vals</span>.<span class="ruby-identifier">keys</span> <span class="ruby-operator">-</span> [<span class="ruby-identifier">:meta</span>] ).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">raw_field_name</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">field_name</span> = <span class="ruby-identifier">raw_field_name</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Symbol</span> <span class="ruby-value">? </span><span class="ruby-identifier">raw_field_name</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">raw_field_name</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">to_sym</span>
            <span class="ruby-identifier">arr_code</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; #{key}.#{field_name} = %~#{vals[field_name]}~ &quot;</span>
          }

          <span class="ruby-identifier">add_to</span> = <span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>][<span class="ruby-identifier">:add_to</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">strip</span>
          <span class="ruby-identifier">after_add</span> = <span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>][<span class="ruby-identifier">:after_add</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">strip</span>
          

          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">add_to</span>.<span class="ruby-identifier">empty?</span>
            <span class="ruby-identifier">arr_code</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; #{key}.save &quot;</span>
          <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>][<span class="ruby-identifier">:add_to</span>][<span class="ruby-value str">'.'</span>]
            <span class="ruby-identifier">arr_code</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; #{ add_to }( #{key} ) &quot;</span>
          <span class="ruby-keyword kw">else</span>
            <span class="ruby-identifier">arr_code</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; #{ add_to }.add_#{class_name.underscore}( #{key} ) &quot;</span>
          <span class="ruby-keyword kw">end</span>

          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">after_add</span>.<span class="ruby-identifier">empty?</span>
            <span class="ruby-comment cmt"># Do nothing.</span>
          <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">after_add</span>[<span class="ruby-value str">'.'</span>]
            <span class="ruby-identifier">arr_code</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">after_add</span>
          <span class="ruby-keyword kw">else</span>
            <span class="ruby-identifier">arr_code</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{key}.#{ after_add }&quot;</span>
          <span class="ruby-keyword kw">end</span>
          
          <span class="ruby-identifier">code</span> = <span class="ruby-identifier">arr_code</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;\n&quot;</span>)
          
          <span class="ruby-keyword kw">begin</span>
            <span class="ruby-identifier">record</span> = <span class="ruby-identifier">eval</span>( <span class="ruby-identifier">code</span> , <span class="ruby-identifier">target_binding</span>, <span class="ruby-keyword kw">__FILE__</span>, <span class="ruby-keyword kw">__LINE__</span> )
          <span class="ruby-keyword kw">rescue</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">RuntimeError</span>, <span class="ruby-node">&quot;Could not evaluate:\n #{code} \n #{$!.class} ===&gt; #{$!.message} &quot;</span>
          <span class="ruby-keyword kw">end</span>
     
      <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># === if !record &amp;&amp; create_record</span>

      <span class="ruby-comment cmt"># Eval into :alias if possible.</span>
      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">record</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">vals</span>[<span class="ruby-identifier">:meta</span>][<span class="ruby-identifier">:alias</span>]
        <span class="ruby-identifier">eval</span>( <span class="ruby-node">&quot;#{vals[:meta][:alias]} = #{key}&quot;</span> ,  <span class="ruby-identifier">target_binding</span>, <span class="ruby-keyword kw">__FILE__</span>, <span class="ruby-keyword kw">__LINE__</span> )
        
      <span class="ruby-keyword kw">end</span>

 
    } <span class="ruby-comment cmt"># data.each { |raw_key, vals|</span>
    
  <span class="ruby-keyword kw">end</span></pre>
</body>
</html>