#!/usr/bin/env bash
# -*- bash -*-
#
#
set -u -e -o pipefail
echo ""

PUBLIC="Public/temp"

if [[ ! "$@" == "" ]]; then
  echo " !!! Not ready to handle individual files." 1>&2
  exit 1
fi

function insert_into_public {
  partial="Server/$1/$2/$3/$4"
  full="$PUBLIC/$1/$2/$4"
  if [[ -f "$partial" ]]; then
    mkdir -p "$(dirname $full)"
    cat "$partial" >> "$full"
    echo "  |-- processed: $partial"
  fi
}

function process_the_css {
  stylus="Server/$1/$2/$3/style.styl"
  css="${stylus/.styl/.css}"
  all_css="$PUBLIC/$1/$2/style.css"

  if [[ -f "$css" ]]; then
    rm_css="no"
  else
    rm_css="yes"
  fi

  if [[ -f "$stylus" ]]; then
    # --- compile into .css
    stylus "$stylus"

    # --- insert
    # --- remove .css
    cat "$css" >> "$all_css"
    if [[ "$rm_css" == 'yes' ]]; then
      rm "$css"
      echo "  -- removed: $css"
    fi
  fi
}

# ==== Find all logics using order.txt file:
files=$( $UP/util/files_with_ext Server/ /order.txt )
for f in $files
do

  group="$( basename "$(dirname "$(dirname $f)")" )"
  name="$( basename "$(dirname $f)" )"
  logics="$(cat $f)"

  echo "|-- in $group/$name"

  # === Reset dir in $PUBLIC/
  mkdir -p  "$PUBLIC/$group/$name"
  echo "" > "$PUBLIC/$group/$name/script.js"
  echo "" > "$PUBLIC/$group/$name/style.css"

  # ==== Now for main Server/ files:
  markup="Server/$group/$name/markup.rb"
  if [[ -f "$markup" ]]; then
    html="$PUBLIC/$group/$name/markup.html"
    bin/bundle exec dot_why ./Public/layout.rb $markup > $html
    echo "  |-- wrote: $html"
  fi

  insert_into_public "$group" "$name" "." "script.js"
  process_the_css    "$group" "$name" "."

  # ==== Now for sub-logic files:
  for l in $logics
  do
    insert_into_public "$group" "$name" "$l" "script.js"
    process_the_css    "$group" "$name" "$l"
  done # === each $logics

done # === each $files




