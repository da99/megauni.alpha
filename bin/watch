#!/usr/bin/env bash
#
#
#
FIRST_RUN="$FIRST_RUN"
set -u -e -o pipefail

if [[ -z "$IS_DEV" ]]
then
  echo "Not a dev machine." 1>&2
  exit 1
fi

start_server () {
  bin/start &
}

restart_server () {
  unicorn=/tmp/unicorn.dev.restart
  since=0

  if [[ -f $unicorn ]]
  then
    since="$(expr "$(date +%s)" - "$(stat $unicorn -c %Y)" )"
  fi

  touch $unicorn

  if [[ "$since" > 3 ]]
  then
    echo "Restarting the server..."
    pkill -HUP  -f  "unicorn master"
  else
    echo "Seconds since last restart: $since"
    echo "-------- No restart -------"
  fi
}

if [[ -z "$FIRST_RUN" ]]
then
  if [[ $FILE =~ ".rb" ]]
  then

    if [[ "$FILE" =~ "Public/" && ! "$FILE" =~ "mustache." ]]
    then
      echo "Template: $FILE"
      bin/compile_html $FILE
    else
      echo "Unknown file: $FILE"
    fi

    restart_server
    echo "=========================="
  fi
fi

cleanup () {
  echo "Quitting..."
  sleep 2 # Wait for unicorn to finish starting.
  pkill -QUIT -f "unicorn master"
  echo "Done"
}

# trap cleanup SIGINT SIGTERM EXIT

echo ""
